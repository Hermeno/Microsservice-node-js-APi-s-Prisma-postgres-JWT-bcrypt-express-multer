name: ðŸš€ Deploy completo da API Node.js com Node local

on:
  push:
    branches:
      - master

jobs:
  deploy:
    name: ðŸŽ‰ Deploy via SSH
    runs-on: ubuntu-latest
    steps:
      - name: ðŸšš Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ›¡ï¸ Deploy via SSH com backup, logs e Node local
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.CPANEL_HOST }}
          username: ${{ secrets.CPANEL_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          envs: |
            NODE_ENV=production
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            API_PORT=3000
          script: |
            set -e
            echo "======================================="
            echo "Iniciando deploy da API Node.js"
            echo "======================================="

            # DiretÃ³rios
            APP_DIR=~/public_html
            TMP_DIR=~/tmp
            BACKUP_DIR=~/backup_$(date +%Y%m%d%H%M%S)
            LOG_DIR=~/deploy_logs
            NODE_DIR=~/node
            mkdir -p $LOG_DIR

            # Backup rÃ¡pido
            echo "Criando backup da aplicaÃ§Ã£o..."
            mkdir -p $BACKUP_DIR
            cp -r $APP_DIR/* $BACKUP_DIR/ || true
            echo "Backup salvo em $BACKUP_DIR"

            # Clonando repositÃ³rio para diretÃ³rio temporÃ¡rio
            echo "Clonando repositÃ³rio para $TMP_DIR..."
            rm -rf $TMP_DIR
            git clone https://github.com/Hermeno/Microsservice-node-js-APi-s-Prisma-postgres-JWT-bcrypt-express-multer.git $TMP_DIR

            # Instalando Node.js local (somente se nÃ£o existir)
            if [ ! -d "$NODE_DIR" ]; then
              echo "Instalando Node.js local..."
              mkdir -p $NODE_DIR
              cd $NODE_DIR
              NODE_VERSION=v20.18.0
              wget https://nodejs.org/dist/$NODE_VERSION/node-$NODE_VERSION-linux-x64.tar.xz
              tar -xf node-$NODE_VERSION-linux-x64.tar.xz --strip-components=1
              rm node-$NODE_VERSION-linux-x64.tar.xz
            fi

            # Ajustando PATH para Node local
            export PATH=$NODE_DIR/bin:$PATH
            node -v
            npm -v

            # Sincronizando arquivos para o diretÃ³rio real
            echo "Sincronizando arquivos para $APP_DIR..."
            cp -r $TMP_DIR/* $APP_DIR/
            rm -rf $TMP_DIR

            # Entrando no diretÃ³rio da aplicaÃ§Ã£o
            cd $APP_DIR

            # Instalando dependÃªncias
            echo "Instalando dependÃªncias..."
            npm ci --omit=dev

            # Aplicando migraÃ§Ãµes do Prisma
            echo "Aplicando migraÃ§Ãµes do Prisma..."
            npx prisma migrate deploy --schema=prisma/schema.prisma

            # Reiniciando aplicaÃ§Ã£o com PM2
            echo "Reiniciando aplicaÃ§Ã£o com PM2..."
            pm2 describe minha-api >/dev/null 2>&1 && pm2 restart minha-api || pm2 start src/app.js --name minha-api

            # Salvando log do deploy
            echo "Deploy concluÃ­do em $(date)" > $LOG_DIR/deploy_$(date +%Y%m%d%H%M%S).log

            echo "======================================="
            echo "âœ… Deploy concluÃ­do com sucesso!"
            echo "======================================="
